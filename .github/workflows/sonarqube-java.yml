name: SonarQube Analysis - Backend Services

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'api-gateway/**'
      - 'user-service/**'
      - 'product-service/**'
      - 'media-service/**'
      - '.github/workflows/sonarqube-java.yml'
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'api-gateway/**'
      - 'user-service/**'
      - 'product-service/**'
      - 'media-service/**'

jobs:
  sonarqube-analysis:
    name: SonarQube Analysis
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [api-gateway, user-service, product-service, media-service]
      fail-fast: false
    
    steps:
      - name: üîÑ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full git history for better analysis
      
      - name: ‚òï Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: üì¶ Cache SonarQube packages
        uses: actions/cache@v3
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar-${{ matrix.service }}
          restore-keys: ${{ runner.os }}-sonar-
      
      - name: üì¶ Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ matrix.service }}-${{ hashFiles(format('{0}/pom.xml', matrix.service)) }}
          restore-keys: |
            ${{ runner.os }}-m2-${{ matrix.service }}-
            ${{ runner.os }}-m2-
      
      - name: üî® Build and Test
        working-directory: ./${{ matrix.service }}
        run: |
          mvn clean verify \
            -B \
            -Dmaven.test.failure.ignore=false
      
      - name: üìä SonarQube Scan
        working-directory: ./${{ matrix.service }}
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SERVICE_UPPER=$(echo "${{ matrix.service }}" | tr '[:lower:]-' '[:upper:]_')
          TOKEN_VAR="SONAR_TOKEN_${SERVICE_UPPER}"
          SONAR_TOKEN="${{ secrets.SONAR_TOKEN_API_GATEWAY }}"
          if [ "${{ matrix.service }}" = "user-service" ]; then SONAR_TOKEN="${{ secrets.SONAR_TOKEN_USER_SERVICE }}"; fi
          if [ "${{ matrix.service }}" = "product-service" ]; then SONAR_TOKEN="${{ secrets.SONAR_TOKEN_PRODUCT_SERVICE }}"; fi
          if [ "${{ matrix.service }}" = "media-service" ]; then SONAR_TOKEN="${{ secrets.SONAR_TOKEN_MEDIA_SERVICE }}"; fi
          
          mvn sonar:sonar \
            -Dsonar.projectKey=ecommerce-${{ matrix.service }} \
            -Dsonar.projectName="E-Commerce ${{ matrix.service }}" \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.token=${SONAR_TOKEN} \
            -Dsonar.java.binaries=target/classes \
            -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml
      
      - name: üìã Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.service }}
          path: ${{ matrix.service }}/target/surefire-reports/
      
      - name: üìã Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.service }}
          path: ${{ matrix.service }}/target/site/jacoco/
      
      - name: ‚è≥ Wait for Quality Gate
        working-directory: ./${{ matrix.service }}
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: |
          SONAR_TOKEN="${{ secrets.SONAR_TOKEN_API_GATEWAY }}"
          if [ "${{ matrix.service }}" = "user-service" ]; then SONAR_TOKEN="${{ secrets.SONAR_TOKEN_USER_SERVICE }}"; fi
          if [ "${{ matrix.service }}" = "product-service" ]; then SONAR_TOKEN="${{ secrets.SONAR_TOKEN_PRODUCT_SERVICE }}"; fi
          if [ "${{ matrix.service }}" = "media-service" ]; then SONAR_TOKEN="${{ secrets.SONAR_TOKEN_MEDIA_SERVICE }}"; fi
          
          echo "‚è≥ Waiting for Quality Gate result..."
          sleep 15
          
          # Get analysis ID from report-task.txt
          if [ ! -f "target/sonar/report-task.txt" ]; then
            echo "‚ùå Error: report-task.txt not found"
            exit 1
          fi
          
          # Extract CE task URL and analysis ID
          CE_TASK_URL=$(grep ceTaskUrl target/sonar/report-task.txt | cut -d'=' -f2-)
          echo "üìä Analysis submitted: $CE_TASK_URL"
          
          # Wait for analysis to complete and check quality gate
          MAX_RETRIES=30
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            # Get task status
            TASK_STATUS=$(curl -s -u "$SONAR_TOKEN:" "$CE_TASK_URL" | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
            
            if [ "$TASK_STATUS" = "SUCCESS" ]; then
              echo "‚úÖ Analysis completed successfully"
              
              # Get analysis ID
              ANALYSIS_ID=$(curl -s -u "$SONAR_TOKEN:" "$CE_TASK_URL" | grep -o '"analysisId":"[^"]*"' | cut -d'"' -f4)
              
              # Check quality gate status
              QG_STATUS=$(curl -s -u "$SONAR_TOKEN:" "${SONAR_HOST_URL}/api/qualitygates/project_status?analysisId=${ANALYSIS_ID}" | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
              
              echo "üéØ Quality Gate Status: $QG_STATUS"
              
              if [ "$QG_STATUS" = "OK" ]; then
                echo "‚úÖ Quality Gate PASSED"
                exit 0
              else
                echo "‚ùå Quality Gate FAILED"
                echo "üîç Check SonarQube dashboard: ${SONAR_HOST_URL}/dashboard?id=ecommerce-${{ matrix.service }}"
                exit 1
              fi
            elif [ "$TASK_STATUS" = "FAILED" ] || [ "$TASK_STATUS" = "CANCELED" ]; then
              echo "‚ùå Analysis task failed with status: $TASK_STATUS"
              exit 1
            fi
            
            echo "‚è≥ Analysis in progress... (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
            sleep 5
            RETRY_COUNT=$((RETRY_COUNT + 1))
          done
          
          echo "‚ö†Ô∏è Timeout waiting for analysis completion"
          echo "üìä Check status manually: ${SONAR_HOST_URL}/dashboard?id=ecommerce-${{ matrix.service }}"
          exit 1
