pipeline {
    agent any
    
    environment {
        PATH = "/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
        DOCKER_NETWORK = "buy-01_default"
        BACKUP_TAG = "backup-${BUILD_NUMBER}"
    }
    
    parameters {
        choice(name: 'ENVIRONMENT', choices: ['dev', 'staging', 'production'], description: 'Deployment Environment')
        booleanParam(name: 'SKIP_TESTS', defaultValue: false, description: 'Skip tests (not recommended)')
        booleanParam(name: 'ROLLBACK', defaultValue: false, description: 'Rollback to previous version')
    }
    
    triggers {
        // GitHub webhook for instant build triggers
        // Configure at: GitHub Repo -> Settings -> Webhooks
        // Payload URL: http://YOUR_JENKINS_URL/github-webhook/
        // Content type: application/json
        // Events: Just the push event
        githubPush()
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'ðŸ“¦ Checking out source code from GitHub...'
                checkout scm
            }
        }
        
        stage('Build Backend Services') {
            parallel {
                stage('User Service') {
                    steps {
                        dir('user-service') {
                            echo 'ðŸ”¨ Building User Service with Docker...'
                            sh 'docker build -t ecommerce/user-service:${BUILD_NUMBER} .'
                            sh 'docker tag ecommerce/user-service:${BUILD_NUMBER} ecommerce/user-service:latest'
                        }
                    }
                }
                stage('Product Service') {
                    steps {
                        dir('product-service') {
                            echo 'ðŸ”¨ Building Product Service with Docker...'
                            sh 'docker build -t ecommerce/product-service:${BUILD_NUMBER} .'
                            sh 'docker tag ecommerce/product-service:${BUILD_NUMBER} ecommerce/product-service:latest'
                        }
                    }
                }
                stage('Media Service') {
                    steps {
                        dir('media-service') {
                            echo 'ðŸ”¨ Building Media Service with Docker...'
                            sh 'docker build -t ecommerce/media-service:${BUILD_NUMBER} .'
                            sh 'docker tag ecommerce/media-service:${BUILD_NUMBER} ecommerce/media-service:latest'
                        }
                    }
                }
                stage('API Gateway') {
                    steps {
                        dir('api-gateway') {
                            echo 'ðŸ”¨ Building API Gateway with Docker...'
                            sh 'docker build -t ecommerce/api-gateway:${BUILD_NUMBER} .'
                            sh 'docker tag ecommerce/api-gateway:${BUILD_NUMBER} ecommerce/api-gateway:latest'
                        }
                    }
                }
            }
        }
        
        stage('Backend Tests') {
            when {
                expression { params.SKIP_TESTS == false && params.ROLLBACK == false }
            }
            parallel {
                stage('User Service Tests') {
                    steps {
                        dir('user-service') {
                            echo 'ðŸ§ª Running User Service JUnit tests...'
                            sh 'mvn test'
                        }
                    }
                    post {
                        always {
                            junit allowEmptyResults: true, testResults: 'user-service/target/surefire-reports/*.xml'
                        }
                    }
                }
                stage('Product Service Tests') {
                    steps {
                        dir('product-service') {
                            echo 'ðŸ§ª Running Product Service JUnit tests...'
                            sh 'mvn test'
                        }
                    }
                    post {
                        always {
                            junit allowEmptyResults: true, testResults: 'product-service/target/surefire-reports/*.xml'
                        }
                    }
                }
                stage('Media Service Tests') {
                    steps {
                        dir('media-service') {
                            echo 'ðŸ§ª Running Media Service JUnit tests...'
                            sh 'mvn test'
                        }
                    }
                    post {
                        always {
                            junit allowEmptyResults: true, testResults: 'media-service/target/surefire-reports/*.xml'
                        }
                    }
                }
                stage('API Gateway Tests') {
                    steps {
                        dir('api-gateway') {
                            echo 'ðŸ§ª Running API Gateway JUnit tests...'
                            sh 'mvn test'
                        }
                    }
                    post {
                        always {
                            junit allowEmptyResults: true, testResults: 'api-gateway/target/surefire-reports/*.xml'
                        }
                    }
                }
            }
        }
        
        stage('Frontend Tests') {
            when {
                expression { params.SKIP_TESTS == false && params.ROLLBACK == false }
            }
            steps {
                dir('frontend') {
                    echo 'ðŸ§ª Running Angular Jasmine/Karma tests...'
                    sh 'npm ci'
                    sh 'npm run test:ci'
                }
            }
            post {
                always {
                    junit allowEmptyResults: true, testResults: 'frontend/test-results/**/*.xml'
                    publishHTML([
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'frontend/coverage/lcov-report',
                        reportFiles: 'index.html',
                        reportName: 'Frontend Code Coverage'
                    ])
                }
            }
        }
        
        stage('Backup Current Deployment') {
            when {
                expression { params.ROLLBACK == false }
            }
            steps {
                script {
                    echo 'ðŸ’¾ Creating backup of current deployment...'
                    sh '''
                        # Tag current images as backup
                        docker tag ecommerce/user-service:latest ecommerce/user-service:${BACKUP_TAG} || true
                        docker tag ecommerce/product-service:latest ecommerce/product-service:${BACKUP_TAG} || true
                        docker tag ecommerce/media-service:latest ecommerce/media-service:${BACKUP_TAG} || true
                        docker tag ecommerce/api-gateway:latest ecommerce/api-gateway:${BACKUP_TAG} || true
                        docker tag ecommerce/frontend:latest ecommerce/frontend:${BACKUP_TAG} || true
                        echo "âœ… Backup created with tag: ${BACKUP_TAG}"
                    '''
                }
            }
        }
        
        stage('Rollback') {
            when {
                expression { params.ROLLBACK == true }
            }
            steps {
                script {
                    echo 'âª Rolling back to previous version...'
                    def previousBuild = currentBuild.number - 1
                    def rollbackTag = "backup-${previousBuild}"
                    
                    echo "Rolling back to build #${previousBuild} (tag: ${rollbackTag})"
                    
                    sh """
                        # Stop current containers
                        docker stop user-service product-service media-service api-gateway frontend 2>/dev/null || true
                        docker rm user-service product-service media-service api-gateway frontend 2>/dev/null || true
                        
                        # Deploy previous versions
                        docker run -d --name user-service --network ${DOCKER_NETWORK} -p 8081:8081 \
                            -e SPRING_PROFILES_ACTIVE=${ENVIRONMENT} ecommerce/user-service:${rollbackTag}
                        
                        docker run -d --name product-service --network ${DOCKER_NETWORK} -p 8082:8082 \
                            -e SPRING_PROFILES_ACTIVE=${ENVIRONMENT} ecommerce/product-service:${rollbackTag}
                        
                        docker run -d --name media-service --network ${DOCKER_NETWORK} -p 8083:8083 \
                            -e SPRING_PROFILES_ACTIVE=${ENVIRONMENT} ecommerce/media-service:${rollbackTag}
                        
                        docker run -d --name api-gateway --network ${DOCKER_NETWORK} -p 8080:8080 \
                            -e SPRING_PROFILES_ACTIVE=${ENVIRONMENT} ecommerce/api-gateway:${rollbackTag}
                        
                        docker run -d --name frontend --network ${DOCKER_NETWORK} -p 4200:80 \
                            ecommerce/frontend:${rollbackTag}
                        
                        echo "âœ… Rollback completed to build #${previousBuild}"
                    """
                }
            }
        }
        
        stage('Deploy Services') {
            when {
                expression { params.ROLLBACK == false }
            }
            steps {
                echo 'ðŸš€ Deploying services to ${ENVIRONMENT}...'
                
                script {
                    // Deploy User Service
                    sh '''
                        docker stop user-service 2>/dev/null || true
                        docker rm user-service 2>/dev/null || true
                        docker run -d --name user-service \
                            --network buy-01_default \
                            -p 8081:8081 \
                            -e SPRING_PROFILES_ACTIVE=${ENVIRONMENT} \
                            -e SSL_ENABLED=false \
                            ecommerce/user-service:${BUILD_NUMBER}
                    '''
                    
                    // Deploy Product Service
                    sh '''
                        docker stop product-service 2>/dev/null || true
                        docker rm product-service 2>/dev/null || true
                        docker run -d --name product-service \
                            --network buy-01_default \
                            -p 8082:8082 \
                            -e SPRING_PROFILES_ACTIVE=${ENVIRONMENT} \
                            -e SSL_ENABLED=false \
                            ecommerce/product-service:${BUILD_NUMBER}
                    '''
                    
                    // Deploy Media Service
                    sh '''
                        docker stop media-service 2>/dev/null || true
                        docker rm media-service 2>/dev/null || true
                        docker run -d --name media-service \
                            --network buy-01_default \
                            -p 8083:8083 \
                            -e SPRING_PROFILES_ACTIVE=${ENVIRONMENT} \
                            -e SSL_ENABLED=false \
                            ecommerce/media-service:${BUILD_NUMBER}
                    '''
                    
                    // Deploy API Gateway
                    sh '''
                        docker stop api-gateway 2>/dev/null || true
                        docker rm api-gateway 2>/dev/null || true
                        docker run -d --name api-gateway \
                            --network buy-01_default \
                            -p 8080:8080 \
                            -e SPRING_PROFILES_ACTIVE=${ENVIRONMENT} \
                            -e SSL_ENABLED=false \
                            ecommerce/api-gateway:${BUILD_NUMBER}
                    '''
                    
                    // Build and deploy Frontend
                    dir('frontend') {
                        sh '''
                            docker stop frontend 2>/dev/null || true
                            docker rm frontend 2>/dev/null || true
                            docker build -t ecommerce/frontend:${BUILD_NUMBER} .
                            docker tag ecommerce/frontend:${BUILD_NUMBER} ecommerce/frontend:latest
                            docker run -d --name frontend \
                                --network buy-01_default \
                                -p 4200:80 \
                                ecommerce/frontend:${BUILD_NUMBER}
                        '''
                    }
                }
            }
        }
        
        stage('Health Checks') {
            when {
                expression { params.ROLLBACK == false }
            }
            steps {
                echo 'ðŸ¥ Running health checks...'
                sleep(time: 20, unit: 'SECONDS')
                
                script {
                    def healthCheckFailed = false
                    def failedServices = []
                    
                    try {
                        sh 'docker exec jenkins-ci curl -f http://api-gateway:8080/actuator/health'
                        echo 'âœ… API Gateway is healthy'
                    } catch (Exception e) {
                        failedServices.add('API Gateway')
                        healthCheckFailed = true
                    }
                    
                    try {
                        sh 'docker exec jenkins-ci curl -f http://user-service:8081/actuator/health'
                        echo 'âœ… User Service is healthy'
                    } catch (Exception e) {
                        failedServices.add('User Service')
                        healthCheckFailed = true
                    }
                    
                    try {
                        sh 'docker exec jenkins-ci curl -f http://product-service:8082/actuator/health'
                        echo 'âœ… Product Service is healthy'
                    } catch (Exception e) {
                        failedServices.add('Product Service')
                        healthCheckFailed = true
                    }
                    
                    try {
                        sh 'docker exec jenkins-ci curl -f http://media-service:8083/actuator/health'
                        echo 'âœ… Media Service is healthy'
                    } catch (Exception e) {
                        failedServices.add('Media Service')
                        healthCheckFailed = true
                    }
                    
                    try {
                        sh 'docker exec jenkins-ci curl -f http://frontend:80'
                        echo 'âœ… Frontend is healthy'
                    } catch (Exception e) {
                        failedServices.add('Frontend')
                        healthCheckFailed = true
                    }
                    
                    if (healthCheckFailed) {
                        echo "âŒ Health check failed for: ${failedServices.join(', ')}"
                        echo "ðŸ”„ Initiating automatic rollback..."
                        error("Deployment failed health checks. Rollback required.")
                    } else {
                        echo 'âœ… All services passed health checks'
                    }
                }
            }
        }
        
        stage('Smoke Tests') {
            when {
                expression { params.ROLLBACK == false }
            }
            steps {
                echo 'ðŸ’¨ Running smoke tests...'
                script {
                    sh '''
                        echo "Testing API Gateway endpoints..."
                        curl -f http://localhost:8080/api/products || echo "Products endpoint not accessible"
                        curl -f http://localhost:8080/api/users || echo "Users endpoint not accessible"
                    '''
                }
            }
        }
    }
    
    post {
        success {
            script {
                def buildDuration = currentBuild.durationString.replace(' and counting', '')
                def message = """
                    âœ… BUILD SUCCESSFUL #${BUILD_NUMBER}
                    
                    ðŸ“¦ Project: Ecommerce Fullstack
                    ðŸŒ¿ Branch: ${env.GIT_BRANCH}
                    â±ï¸ Duration: ${buildDuration}
                    ðŸš€ Environment: ${params.ENVIRONMENT}
                    ðŸ‘¤ Started by: ${currentBuild.getBuildCauses()[0].userId ?: 'SCM'}
                    
                    ðŸ”— Build URL: ${env.BUILD_URL}
                    
                    Services deployed:
                    - User Service: http://localhost:8081
                    - Product Service: http://localhost:8082
                    - Media Service: http://localhost:8083
                    - API Gateway: http://localhost:8080
                    - Frontend: http://localhost:4200
                """.stripIndent()
                
                echo message
                
                // Email notification (configure in Jenkins)
                // emailext (
                //     subject: "âœ… Build #${BUILD_NUMBER} Successful",
                //     body: message,
                //     to: 'team@example.com'
                // )
                
                // Slack notification (requires Slack plugin)
                // slackSend (
                //     color: 'good',
                //     message: message,
                //     channel: '#deployments'
                // )
            }
        }
        
        failure {
            script {
                def buildDuration = currentBuild.durationString.replace(' and counting', '')
                def failedStage = env.STAGE_NAME ?: 'Unknown'
                
                // Get test failure details
                def testFailures = ''
                try {
                    def testResults = currentBuild.rawBuild.getAction(hudson.tasks.junit.TestResultAction.class)
                    if (testResults) {
                        testFailures = """
                        ðŸ“Š Test Results:
                        - Total: ${testResults.totalCount}
                        - Failed: ${testResults.failCount}
                        - Skipped: ${testResults.skipCount}
                        - Pass Rate: ${testResults.totalCount > 0 ? ((testResults.totalCount - testResults.failCount) * 100 / testResults.totalCount).round(2) : 0}%
                        """.stripIndent()
                    }
                } catch (Exception e) {
                    testFailures = '(Test results not available)'
                }
                
                def message = """
                    âŒ BUILD FAILED #${BUILD_NUMBER}
                    
                    ðŸ“¦ Project: Ecommerce Fullstack
                    ðŸŒ¿ Branch: ${env.GIT_BRANCH}
                    â±ï¸ Duration: ${buildDuration}
                    ðŸš€ Environment: ${params.ENVIRONMENT}
                    ðŸŽ¯ Failed Stage: ${failedStage}
                    ðŸ‘¤ Started by: ${currentBuild.getBuildCauses()[0].userId ?: 'SCM'}
                    
                    ${testFailures}
                    
                    ðŸ”— Build URL: ${env.BUILD_URL}
                    ðŸ“‹ Test Report: ${env.BUILD_URL}testReport/
                    ðŸ“Š Console Log: ${env.BUILD_URL}console
                    
                    âš ï¸ Action Required: 
                    1. Check test failures in Test Report
                    2. Review console logs for error details
                    3. Fix the failing tests/build
                    
                    ðŸ’¡ Quick Rollback: Run build with ROLLBACK=true parameter
                """.stripIndent()
                
                echo message
                
                // Email notification
                // emailext (
                //     subject: "âŒ Build #${BUILD_NUMBER} Failed - ${failedStage}",
                //     body: message,
                //     to: 'team@example.com',
                //     attachLog: true
                // )
                
                // Slack notification
                // slackSend (
                //     color: 'danger',
                //     message: message,
                //     channel: '#deployments'
                // )
                
                // Automatic rollback on deployment failure
                if (failedStage.contains('Deploy') || failedStage.contains('Health Check')) {
                    echo 'ðŸ”„ Deployment failed! Automatic rollback initiated...'
                    try {
                        sh 'docker-compose -f docker-compose.yml down'
                        sh 'docker-compose -f docker-compose.yml up -d'
                        echo 'âœ… Rollback completed - services restored to previous version'
                    } catch (Exception e) {
                        echo "âš ï¸ Automatic rollback failed: ${e.message}"
                        echo 'ðŸ’¡ Manual intervention required - check docker-compose.yml'
                    }
                } else {
                    echo 'ðŸ”„ Consider running rollback: trigger build with ROLLBACK=true'
                }
            }
        }
        
        unstable {
            script {
                def testResults = currentBuild.rawBuild.getAction(hudson.tasks.junit.TestResultAction.class)
                def unstableMessage = """
                    âš ï¸ BUILD UNSTABLE #${BUILD_NUMBER}
                    
                    Some tests failed but build completed.
                    
                    ðŸ“Š Test Results:
                    - Total: ${testResults?.totalCount ?: 'N/A'}
                    - Failed: ${testResults?.failCount ?: 'N/A'}
                    - Skipped: ${testResults?.skipCount ?: 'N/A'}
                    
                    ðŸ”— Test Report: ${env.BUILD_URL}testReport/
                """.stripIndent()
                
                echo unstableMessage
                
                // slackSend(color: 'warning', message: unstableMessage, channel: '#deployments')
            }
        }
        
        always {
            script {
                echo 'ðŸ§¹ Cleaning up...'
                // Clean old Docker images to save space
                sh '''
                    # Remove dangling images
                    docker image prune -f
                    
                    # Keep only last 5 builds of each service
                    for service in user-service product-service media-service api-gateway frontend; do
                        docker images ecommerce/$service --format "{{.Tag}}" | grep -E "^[0-9]+$" | sort -rn | tail -n +6 | xargs -I {} docker rmi ecommerce/$service:{} 2>/dev/null || true
                    done
                '''
                echo 'âœ… Cleanup completed'
            }
        }
    }
}
